# 실시간 스트리밍 서버 README

## 1. 프로젝트 개요
MQTT와 TCP 소켓 통신을 결합한 실시간 카메라 스트리밍 시스템

클라이언트의 동적 서버 탐색 및 직접 연결을 통해 영상 데이터 수신. 서버는 라즈베리파이의 libcamera 스택을 직접 활용하여 높은 성능과 안정성 확보

***

## 2. 프로젝트 구조
```
/
├── server/
│   ├── main.py             # 서버 메인 프로세스 (MQTT/스트림 관리)
│   ├── mqtt_manager.py     # 서비스 탐색 기능 (MQTT)
│   └── stream_server.py    # 영상 스트리밍 기능 (Socket)
│
├── client/
│   └── test.py             # 클라이언트 애플리케이션 예제
│
├── config.py               # 공통 설정 파일
└── README.md               
```

***

## 3. 전체 시스템 흐름

1. 서버 시작: server/main.py 실행 시, MQTT 관리자와 스트리밍 서버 두 프로세스 동시 실행

2. 서버 탐색 (Discovery): 클라이언트, commend 토픽으로 자신의 고유 응답 토픽 주소 발행

3. IP 응답: 서버의 MQTT 관리자, 요청을 수신하고 해당 응답 토픽으로 자신의 로컬 IP 주소 발행

4. 연결 및 스트리밍: 클라이언트, 응답받은 IP를 이용해 스트리밍 서버에 직접 소켓 연결. 연결 후 서버는 실시간 영상 프레임 지속 전송

***

## 4. 각 파일 기능 설명
* config.py:

    > MQTT 브로커, 포트, 토픽 등 시스템의 모든 공통 설정 관리

* server/main.py:

    > 서버의 메인 시작점. multiprocessing을 이용, 두 핵심 기능(MQTT, 스트리밍)을 독립 프로세스로 실행하여 안정성 확보
    >
    > Ctrl+C 입력 시 프로세스 안전 종료 기능 포함

* server/mqtt_manager.py:

    > 서비스 탐색 기능 담당. paho-mqtt 라이브러리 사용

    > commend 토픽 구독 및 클라이언트의 IP 요청에 대한 응답 로직 구현

* server/stream_server.py:

    > 실시간 영상 스트리밍 담당. subprocess로 libcamera-vid를 직접 실행하여 고효율 스트림 생성

    > socket 서버를 통해 연결된 다중 클라이언트에게 스레드(Thread)를 할당하여 영상 프레임 전송

* client/test.py:

    > 단일 서버 접속 클라이언트의 전체 워크플로우를 보여주는 예제 코드

    > MQTT로 IP 획득 후, 해당 IP로 소켓 접속 및 OpenCV를 통한 영상 시각화 기능 구현

***

### 5. 클라이언트 구현 가이드라인

### 5.1. 단일 서버 접속 (현 예제 코드)
> get_server_ip_from_mqtt() 함수로 단일 서버 IP 획득
>
> start_stream_client(server_ip) 함수로 해당 서버 접속 및 스트림 처리

### 5.2. 다중 서버 동시 접속 (구현 방향)

> 현재 코드는 다중 서버 동시 시각화 미지원. 기능 구현을 위해 클라이언트의 멀티프로세싱 기반 재설계 필요

#### 현재 클라이언트 예제 코드의 한계
단일 서버 접속만 가능

    순차적 로직: MQTT를 통해 가장 먼저 응답한 단일 서버의 IP만 획득 후 탐색을 중단함
    블로킹 동작: 단일 서버와 스트리밍이 시작되면, 해당 연결을 처리하는 무한 루프에 고정되어 다른 서버에 추가로 접속 불가

#### 다중 서버 동시 접속을 위한 확장 방향
클라이언트의 멀티프로세싱(multiprocessing) 기반 재설계 필요.

    MQTT 리스너: 별도 스레드를 통해 여러 서버의 IP 주소를 지속적으로 수신 및 관리
    프로세스 관리자: 메인 프로세스에서 새로운 서버 IP가 발견될 때마다, 해당 스트림을 전담할 자식 프로세스를 동적으로 생성 및 관리 필요

***

## 테스트 코드 리뷰
